# ==============================
# ðŸ”§ Build Stage
# ==============================
FROM alpine:3.18 AS build

RUN apk add --no-cache --virtual .build-deps \
    gcc musl-dev make libxslt libxml2-dev \
    pcre-dev git wget openssl-dev build-base \
    zlib-dev linux-headers bash libmaxminddb-dev

# ä½¿ç”¨æ¸…åŽé•œåƒä¸‹è½½ Nginx æºç 
RUN wget http://nginx.org/download/nginx-1.27.0.tar.gz && \
    tar -zxvf nginx-1.27.0.tar.gz && \
    cd nginx-1.27.0 && \
    # ä¸‹è½½ vhost_traffic_status æ¨¡å—
    git clone -b v0.2.2 https://github.com/vozlt/nginx-module-vts.git && \
    # ä¸‹è½½ geoip2 æ¨¡å—
    git clone https://github.com/leev/ngx_http_geoip2_module.git && \
    # ç¼–è¯‘ Nginx æ¨¡å—
    ./configure \
      --prefix=/var/lib/nginx \
      --sbin-path=/usr/sbin/nginx \
      --modules-path=/opt/nginx/modules \
      --conf-path=/etc/nginx/nginx.conf \
      --with-http_ssl_module \
      --with-http_v2_module \
      --with-http_realip_module \
      --with-http_stub_status_module \
      --with-compat \
      --with-stream \
      --add-dynamic-module=nginx-module-vts \
      --add-dynamic-module=ngx_http_geoip2_module && \
    make && make install

RUN apk del .build-deps && rm -rf nginx-1.27.0 nginx-1.27.0.tar.gz

# ==============================
# ðŸš€ Runtime Stage
# ==============================
FROM alpine:3.18

RUN apk add --no-cache \
    nginx supervisor bash curl libmaxminddb

ENV GEOIP_PATH=/opt/nginx/geoip

RUN mkdir -p /run/nginx /etc/nginx/conf.d /etc/nginx/stream.d \
    /opt/nginx/modules /opt/nginx/logs \
    /etc/supervisor.d /var/log/supervisor /var/run/supervisor \
    $GEOIP_PATH /etc/letsencrypt/stage

COPY --from=build /usr/sbin/nginx /usr/sbin/nginx
COPY --from=build /var/lib/nginx /etc/nginx
COPY --from=build /opt/nginx/modules/* /opt/nginx/modules/

# ðŸ‘‡ æ›¿æ¢ä¸ºæˆ‘ä»¬æ”¹è¿‡çš„ nginx.conf å’Œå…¥å£è„šæœ¬
COPY nginx.conf /etc/nginx/nginx.conf
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# ðŸ”§ é…ç½® supervisord
RUN echo "[supervisord]" > /etc/supervisord.conf && \
    echo "nodaemon=true" >> /etc/supervisord.conf && \
    echo "logfile=/var/log/supervisor/supervisord.log" >> /etc/supervisord.conf && \
    echo "[program:nginx]" >> /etc/supervisord.conf && \
    echo "command=/usr/sbin/nginx -c /etc/nginx/nginx.conf -g 'daemon off;'" >> /etc/supervisord.conf && \
    echo "autostart=true" >> /etc/supervisord.conf && \
    echo "autorestart=true" >> /etc/supervisord.conf && \
    echo "stdout_logfile=/var/log/supervisor/nginx.log" >> /etc/supervisord.conf && \
    echo "stderr_logfile=/var/log/supervisor/nginx_err.log" >> /etc/supervisord.conf

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]

